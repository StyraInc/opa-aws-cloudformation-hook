on:
  push:
    branches: [ main ]
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch: # Enables on-demand/manual triggering
jobs:
  job:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - run: |
          types=$(curl -s --compressed https://d1uauaxba7bl26.cloudfront.net/latest/gzip/CloudFormationResourceSpecification.json | jq '.ResourceTypes | keys')
          jq --argjson types "$types" '.handlers.preCreate.targetNames = $types' hooks/styra-opa-hook.json > tmp && mv tmp hooks/styra-opa-hook.json
          jq --argjson types "$types" '.handlers.preUpdate.targetNames = $types' hooks/styra-opa-hook.json > tmp && mv tmp hooks/styra-opa-hook.json
          jq --argjson types "$types" '.handlers.preDelete.targetNames = $types' hooks/styra-opa-hook.json > tmp && mv tmp hooks/styra-opa-hook.json
      - uses: peter-evans/create-pull-request@v3
        with:
          commit-message: |
            autogenerated maintenance
          title: autogenerated maintenance
          delete-branch: true
          body: |
            If tests are stuck on https://github.com/peter-evans/create-pull-request/issues/48:
            ["Manually close pull requests and immediately reopen them. This will enable `on: pull_request` workflows to run and be added as checks."](https://github.com/peter-evans/create-pull-request/blob/master/docs/concepts-guidelines.md#triggering-further-workflow-runs)
